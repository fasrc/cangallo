#!/usr/bin/env ruby

# vim:ts=2:sw=2

$: << File.dirname(__FILE__) + "/../lib"

require "rubygems"
require "thor"
require "fileutils"
require "digest"
require "cangallo"
require "tempfile"

require "pp"

$cangallo = Cangallo.new

class Canga < Thor
  class_option :repo, :desc => 'repository to use'

  desc "create FILE [SIZE]", "create a new qcow2 image"
  option :parent, :desc => "id of the parent image"
  def create(file, size=nil)
    puts [file, size]
    Cangallo::Qcow2.create(file, options[:parent], size)
  end

  desc "add FILE", "add a new file to the repository"
  option :parent, :desc => "id of the parent image"
  option :tag, :desc => "tag name of the new image"
  def add(file)
    repo = $cangallo.repo(options[:repo])
    sha256 = repo.add_image(file)

    repo.add_tag(options[:tag], sha256) if options[:tag]
  end

  desc "tag TAGNAME IMAGE", "add a tag name to an existing image"
  def tag(tag, sha256)
    repo = $cangallo.repo(options[:repo])
    repo.add_tag(tag, sha256)
  end

  desc "list", "list images"
  def list()
    repo = $cangallo.repo(options[:repo])
    repo_name = repo.name

    images = $cangallo.get_images

    format = "%-30.30s %11.11s %-30.30s"

    puts format % %w{NAME SIZE DESCRIPTION}

    images.each do |image|
      parent = image["parent"] ? "*" : " "
      name = "#{parent}#{image["name"]}"

      size = image["size"].to_f / (1024 * 1024) # Mb
      size = size.round(1)

      puts format % [name, "#{size} Mb", image["description"]]
    end
  end

  desc "show IMAGE", "show information about an image"
  def show(name)
    repo = $cangallo.repo(options[:repo])
    image = repo.get(name)

    if image
      pp image
    else
      SDTERR.puts "No image found with name '#{name}'"
      exit(-1)
    end
  end

  desc "overlay IMAGE FILE", "create a new image based on another one"
  def overlay(sha256, file)
    repo = $cangallo.repo(options[:repo])

    image = repo.find(sha256)

    if !image
      STDERR.puts "Image not found"
      exit(-1)
    end

    path = File.expand_path(repo.image_path(sha256))

    Cangallo::Qcow2.create_from_base(path, file)
  end

  desc "build CANGAFILE", "create a new image using a Cangafile"
  def build(file)
    repo = $cangallo.repo(options[:repo])
    cangafile = Cangallo::Cangafile.new(file)

    puts cangafile.libguestfs_commands

    sha256 = repo.find(cangafile.parent)

    if !sha256
      STDERR.puts "Image not found"
      exit(-1)
    end

    parent_path = File.expand_path(repo.image_path(sha256))

    # temp image path
    temp_image = Tempfile.new([File.basename(file), '.qcow2'], repo.path)
    temp_image.close

    Cangallo::Qcow2.create_from_base(parent_path, temp_image.path)

    rc = Cangallo::LibGuestfs.virt_customize(temp_image.path, cangafile.libguestfs_commands)
    exit(-1) if !rc

    rc = Cangallo::LibGuestfs.virt_sparsify(temp_image.path)
    exit(-1) if !rc

    data = {}
    data["parent"] = sha256
    data["description"] = cangafile.data["description"]
    data["os"] = cangafile.data["os"]
    cangafile.data.delete("description")
    cangafile.data.delete("os")

    data["cangafile"] = cangafile.data

    repo.add_image(temp_image.path, data)

    puts "Deleting temporary image"
    temp_image.delete
  end

  desc "fetch", "download the index of the repository"
  def fetch
    repo = $cangallo.repo(options[:repo])

    repo.fetch
  end

  desc "sign", "sign the index file with keybase"
  def sign
    repo = $cangallo.repo(options[:repo])
    repo.sign
  end

  desc "verify", "verify index signature with keybase"
  def verify
    repo = $cangallo.repo(options[:repo])
    repo.verify
  end

  desc "pull NAME", "downloads an image from a remote repository"
  def pull(name)
    repo = $cangallo.repo(options[:repo])
    repo.pull(name)
  end
  
  desc "export IMAGE OUTPUT", "export an image to a file"
  option :format, :desc => "format for output image", :default => :qcow2, :alliases => :f
  option :compress, :desc => "compress output qcow2 image", :default => false, :alliases => :c
  def export(image, output)
    repo = $cangallo.repo(options[:repo])
    sha256 = repo.find(image)

    if !sha256
      STDERR.puts "Image not found"
      exit(-1)
    end

    path = File.expand_path(repo.image_path(sha256))
    
    Cangallo::Qcow2.new(path).convert(output,options)
  end

end

Canga.start(ARGV)


